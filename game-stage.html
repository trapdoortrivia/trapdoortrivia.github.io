<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game Stage - Trapdoor Trivia</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/game.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <div class="stage-lights" id="stageLights"></div>
    
    <!-- Sound Toggle -->
    <button class="sound-toggle" id="soundToggle">ðŸ”Š</button>
    
    <div class="game-container">
        <!-- HOST VIEW -->
        <div class="host-game-view hidden" id="hostGameView">
            <div class="host-header">
                <h1 class="game-title">HOST CONTROL PANEL</h1>
                <div class="host-stats">
                    <div class="stat-box">
                        <span class="stat-label">Players Alive:</span>
                        <span class="stat-value" id="hostPlayersAlive">0</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Question:</span>
                        <span class="stat-value" id="hostQuestionNumber">0</span>
                    </div>
                </div>
            </div>

            <!-- Current Question Display -->
            <div class="host-question-display">
                <div class="difficulty-selector">
                    <h3>Difficulty:</h3>
                    <div class="diff-buttons">
                        <button class="diff-btn easy active" onclick="setDifficulty('easy')">EASY (5s)</button>
                        <button class="diff-btn medium" onclick="setDifficulty('medium')">MEDIUM (10s)</button>
                        <button class="diff-btn hard" onclick="setDifficulty('hard')">HARD (15s)</button>
                    </div>
                </div>

                <div class="current-question-box">
                    <div class="difficulty-badge easy" id="hostDifficultyBadge">EASY</div>
                    <h2 class="host-question-text" id="hostQuestionText">Click "Start Question" to begin</h2>
                    <div class="host-answers" id="hostAnswers">
                        <div class="answer-option correct" id="hostAnswer0">A: Answer will appear here</div>
                        <div class="answer-option" id="hostAnswer1">B: Answer will appear here</div>
                        <div class="answer-option" id="hostAnswer2">C: Answer will appear here</div>
                    </div>
                </div>

                <div class="timer-display">
                    <div class="timer-big" id="hostTimer">-</div>
                    <div class="timer-bar">
                        <div class="timer-fill" id="hostTimerFill"></div>
                    </div>
                </div>
            </div>

            <!-- Host Controls -->
            <div class="host-controls-panel">
                <button class="btn btn-primary btn-large" onclick="startNextQuestion()" id="startQuestionBtn">START QUESTION</button>
                <button class="btn btn-secondary" onclick="revealAnswerEarly()" id="revealBtn" style="display: none;">REVEAL ANSWER</button>
                <button class="btn btn-danger" onclick="endGame()">END GAME</button>
            </div>

            <!-- Player Positions Display -->
            <div class="host-player-positions">
                <h3>Player Positions:</h3>
                <div class="position-display">
                    <div class="position-box">
                        <div class="position-label">A (Green)</div>
                        <div class="position-players" id="hostPlayersA"></div>
                    </div>
                    <div class="position-box">
                        <div class="position-label">B (Blue)</div>
                        <div class="position-players" id="hostPlayersB"></div>
                    </div>
                    <div class="position-box">
                        <div class="position-label">C (Red)</div>
                        <div class="position-players" id="hostPlayersC"></div>
                    </div>
                    <div class="position-box">
                        <div class="position-label">Not Positioned</div>
                        <div class="position-players" id="hostPlayersNone"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PLAYER VIEW -->
        <div class="player-game-view hidden" id="playerGameView">
            <!-- Question Display -->
            <div class="question-container">
                <div class="difficulty-badge easy" id="playerDifficultyBadge">EASY</div>
                <h2 class="question-text" id="playerQuestionText">Waiting for host to start question...</h2>
                <div class="timer-container hidden" id="playerTimerContainer">
                    <div class="timer" id="playerTimer">5</div>
                    <div class="timer-bar">
                        <div class="timer-fill" id="playerTimerFill"></div>
                    </div>
                </div>
            </div>

            <!-- Trapdoors -->
            <div class="trapdoor-container">
                <div class="trapdoor" data-answer="0" onclick="selectTrapdoor(0)">
                    <div class="trapdoor-platform" id="trapdoor0">
                        <div class="trapdoor-label" id="playerAnswer0">A</div>
                        <div class="players-on-trapdoor" id="players0"></div>
                    </div>
                </div>
                <div class="trapdoor" data-answer="1" onclick="selectTrapdoor(1)">
                    <div class="trapdoor-platform" id="trapdoor1">
                        <div class="trapdoor-label" id="playerAnswer1">B</div>
                        <div class="players-on-trapdoor" id="players1"></div>
                    </div>
                </div>
                <div class="trapdoor" data-answer="2" onclick="selectTrapdoor(2)">
                    <div class="trapdoor-platform" id="trapdoor2">
                        <div class="trapdoor-label" id="playerAnswer2">C</div>
                        <div class="players-on-trapdoor" id="players2"></div>
                    </div>
                </div>
            </div>

            <!-- Game Info -->
            <div class="game-info-bar">
                <div class="info-item">
                    <span class="info-label">Players Alive:</span>
                    <span class="info-value" id="playersAliveCount">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Question:</span>
                    <span class="info-value" id="playerQuestionNumber">0</span>
                </div>
                <div class="info-item sudden-death-indicator hidden" id="playerSuddenDeathIndicator">
                    ðŸ’€ SUDDEN DEATH ðŸ’€
                </div>
            </div>

            <!-- Player Status -->
            <div class="player-status">
                <div class="my-player-info">
                    <span class="my-emoji" id="myEmojiDisplay"></span>
                    <span class="my-name" id="myNameDisplay"></span>
                    <span class="position-status" id="positionStatus">Click a trapdoor to position yourself!</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/game-state.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/utils.js"></script>
    
    <script>
        let currentQuestion = null;
        let timerInterval = null;
        let pollInterval = null;
        let gameActive = false;
        let questionActive = false;
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== GAME STAGE PAGE LOADING ===');
            console.log('Current game state:', gameState.getDebugInfo());
            
            // Check backup storage
            const backupRole = localStorage.getItem('trapdoorTriviaRole');
            const backupGameCode = localStorage.getItem('trapdoorTriviaGameCode');
            const backupGameId = localStorage.getItem('trapdoorTriviaGameId');
            console.log('Backup storage - Role:', backupRole, 'Code:', backupGameCode, 'ID:', backupGameId);
            
            // If main state is missing but we have backup, use backup
            if (!gameState.gameCode && backupGameCode) {
                console.log('Using backup storage to restore state...');
                gameState.setGameCode(backupGameCode);
                if (backupRole) gameState.setRole(backupRole);
                if (backupGameId) gameState.gameId = parseInt(backupGameId);
                gameState.saveToStorage();
                console.log('State restored from backup:', gameState.getDebugInfo());
            }
            
            // Check if we have valid game state
            if (!gameState.gameCode) {
                console.error('No game code found in any storage');
                showNotification('No active game found.', 'error');
                setTimeout(() => navigateTo('index.html'), 2000);
                return;
            }
            
            // ENHANCED GAME STATUS CHECK WITH RETRIES
            let game = null;
            let attempts = 0;
            const maxAttempts = 5;
            
            while (!game && attempts < maxAttempts) {
                attempts++;
                console.log(`Checking game status (attempt ${attempts}/${maxAttempts})...`);
                
                try {
                    game = await supabase.getGame(gameState.gameCode);
                    console.log('Game found:', game);
                    
                    if (game) {
                        break; // Game found, exit retry loop
                    }
                } catch (error) {
                    console.warn(`Game check attempt ${attempts} failed:`, error);
                }
                
                // Wait before retry (except on last attempt)
                if (attempts < maxAttempts) {
                    console.log('Waiting 1 second before retry...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            // If we still don't have a game after retries
            if (!game) {
                console.error('Game not found after all attempts');
                showNotification('Game not found. Please check your connection.', 'error');
                setTimeout(() => navigateTo('index.html'), 2000);
                return;
            }
            
            // Check game status - be more flexible for timing issues
            console.log('Game status:', game.status);
            
            if (game.status === 'waiting') {
                console.log('Game is still waiting, redirecting appropriately');
                // Give a brief delay in case status is still updating
                setTimeout(async () => {
                    const recheck = await supabase.getGame(gameState.gameCode);
                    if (recheck && recheck.status === 'playing') {
                        console.log('Game status updated to playing, continuing...');
                        window.location.reload(); // Reload to continue with playing status
                    } else {
                        if (gameState.role === 'host') {
                            navigateTo('host.html');
                        } else {
                            navigateTo('waiting-room.html');
                        }
                    }
                }, 2000);
                return;
            }
            
            if (game.status === 'finished') {
                console.log('Game is finished');
                setTimeout(() => navigateTo('victory.html'), 1000);
                return;
            }
            
            if (game.status !== 'playing') {
                console.log('Game status is unexpected:', game.status);
                showNotification('Game is in an unexpected state.', 'error');
                setTimeout(() => navigateTo('index.html'), 2000);
                return;
            }
            
            console.log('Game is playing, proceeding with stage setup');
            
            // BULLETPROOF ROLE DETECTION LOGIC
            console.log('=== DETERMINING USER ROLE ===');
            console.log('gameState.role:', gameState.role);
            console.log('backupRole:', backupRole);
            console.log('gameState.playerId:', gameState.playerId);
            console.log('gameState.playerName:', gameState.playerName);
            console.log('gameState.playerEmoji:', gameState.playerEmoji);
            
            // Check all possible indicators that this is the host
            const isHostIndicators = [
                gameState.role === 'host',
                backupRole === 'host',
                localStorage.getItem('trapdoorTriviaRole') === 'host',
                localStorage.getItem('trapdoorTriviaIsHost') === 'true',
                sessionStorage.getItem('trapdoorTriviaRole') === 'host',
                sessionStorage.getItem('trapdoorTriviaIsHost') === 'true'
            ];
            
            // Check all possible indicators that this is a player
            const isPlayerIndicators = [
                gameState.playerId != null && gameState.playerId !== undefined,
                gameState.playerName != null && gameState.playerName !== undefined,
                gameState.playerEmoji != null && gameState.playerEmoji !== undefined,
                gameState.role === 'player',
                backupRole === 'player',
                localStorage.getItem('trapdoorTriviaRole') === 'player'
            ];
            
            console.log('Host indicators:', isHostIndicators);
            console.log('Player indicators:', isPlayerIndicators);
            console.log('Any host indicator true?', isHostIndicators.some(indicator => indicator));
            console.log('Any player indicator true?', isPlayerIndicators.some(indicator => indicator));
            
            let finalRole;
            
            // If ANY host indicator is true, this is the host
            if (isHostIndicators.some(indicator => indicator)) {
                finalRole = 'host';
                console.log('âœ… DETERMINED AS HOST - found host indicator');
            }
            // If we have player indicators and no host indicators, this is a player
            else if (isPlayerIndicators.some(indicator => indicator)) {
                finalRole = 'player';
                console.log('âœ… DETERMINED AS PLAYER - found player indicator');
            }
            // Last resort: check database
            else if (gameState.gameCode) {
                try {
                    console.log('ðŸ” Checking database as last resort...');
                    const players = await supabase.select('players', `game_code=eq.${gameState.gameCode}`);
                    console.log('Players found in database:', players.length);
                    
                    // If there are no players, this must be the host
                    if (!players || players.length === 0) {
                        finalRole = 'host';
                        console.log('âœ… DETERMINED AS HOST - no players in database');
                    } else {
                        finalRole = 'player';
                        console.log('âœ… DETERMINED AS PLAYER - players exist in database');
                    }
                } catch (error) {
                    console.error('âŒ Error checking database:', error);
                    finalRole = 'player'; // Default to player on error
                    console.log('âš ï¸ DEFAULTED TO PLAYER due to database error');
                }
            }
            // Ultimate fallback
            else {
                finalRole = 'player';
                console.log('âš ï¸ DEFAULTED TO PLAYER - no indicators found');
            }
            
            console.log('ðŸŽ¯ FINAL ROLE DECISION:', finalRole);
            
            // Update game state with determined role
            gameState.setRole(finalRole);
            
            console.log('Game stage loading for role:', finalRole);
            console.log('Game code:', gameState.gameCode);
            console.log('Game ID:', gameState.gameId);
            
            // Show appropriate view based on FINAL role
            if (finalRole === 'host') {
                console.log('ðŸŽ® SHOWING HOST DASHBOARD');
                document.getElementById('hostGameView').classList.remove('hidden');
                document.getElementById('playerGameView').classList.add('hidden');
                await initializeHost();
            } else {
                console.log('ðŸ‘¤ SHOWING PLAYER VIEW');
                document.getElementById('playerGameView').classList.remove('hidden');
                document.getElementById('hostGameView').classList.add('hidden');
                await initializePlayer();
            }
            
            // Common event listeners
            document.getElementById('soundToggle').addEventListener('click', toggleSound);
            document.addEventListener('keydown', handleKeyInput);
            
            // Start polling for game updates
            startGamePolling();
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', cleanup);
        });
        
        // HOST FUNCTIONS
        async function initializeHost() {
            console.log('=== INITIALIZING HOST VIEW ===');
            
            // Load questions if not already loaded
            if (!gameState.questions || Object.keys(gameState.questions).length === 0) {
                gameState.questions = await supabase.getAllQuestionsGrouped();
                console.log('Questions loaded:', Object.keys(gameState.questions));
            }
            
            // Set initial state
            gameState.currentQuestion = 0;
            $('hostQuestionNumber').textContent = '0';
            
            // Update player count
            await updateHostDisplay();
            
            console.log('Host view initialized successfully');
        }
        
        async function startNextQuestion() {
            try {
                gameState.currentQuestion++;
                
                const difficulty = gameState.suddenDeath ? 'hard' : gameState.difficulty;
                const questionBank = gameState.questions[difficulty] || [];
                
                if (questionBank.length === 0) {
                    showNotification('No questions available!', 'error');
                    return;
                }
                
                // Pick random question
                const questionIndex = Math.floor(Math.random() * questionBank.length);
                currentQuestion = questionBank[questionIndex];
                
                console.log('Starting question:', currentQuestion);
                
                // Update database with question info
                await supabase.update('games', gameState.gameId, {
                    current_question: gameState.currentQuestion,
                    question_index: questionIndex,
                    difficulty: difficulty,
                    correct_answer: currentQuestion.correct,
                    last_activity: new Date().toISOString()
                });
                
                // Update host display
                displayHostQuestion(currentQuestion, difficulty);
                
                // Start countdown
                startHostTimer(currentQuestion.correct);
                
                // Update button states
                hide('startQuestionBtn');
                show('revealBtn');
                questionActive = true;
                
            } catch (error) {
                console.error('Error starting question:', error);
                showNotification('Failed to start question', 'error');
            }
        }
        
        function displayHostQuestion(question, difficulty) {
            // Update difficulty badge
            const badge = $('hostDifficultyBadge');
            badge.textContent = difficulty.toUpperCase();
            badge.className = `difficulty-badge ${difficulty}`;
            
            // Update question text
            $('hostQuestionText').textContent = question.question;
            
            // Update answers and mark correct one
            question.answers.forEach((answer, index) => {
                const answerEl = $(`hostAnswer${index}`);
                answerEl.textContent = `${String.fromCharCode(65 + index)}: ${answer}`;
                answerEl.classList.remove('correct');
                
                if (index === question.correct) {
                    answerEl.classList.add('correct');
                }
            });
            
            // Update question number
            $('hostQuestionNumber').textContent = gameState.currentQuestion;
        }
        
        function startHostTimer(correctAnswer) {
            const duration = gameState.suddenDeath ? 5 : 
                           gameState.difficulty === 'easy' ? 5 :
                           gameState.difficulty === 'medium' ? 10 : 15;
            
            let timeLeft = duration;
            const timerEl = $('hostTimer');
            const timerFill = $('hostTimerFill');
            
            // Reset timer display
            timerEl.classList.remove('danger');
            timerFill.style.width = '100%';
            timerFill.classList.remove('danger');
            
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                // Update progress bar
                const percentage = (timeLeft / duration) * 100;
                timerFill.style.width = percentage + '%';
                
                // Danger zone
                if (timeLeft <= 3) {
                    timerEl.classList.add('danger');
                    timerFill.classList.add('danger');
                    playSound('countdown');
                }
                
                // Time's up!
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    questionActive = false;
                    revealAnswer(correctAnswer);
                }
            }, 1000);
        }
        
        async function revealAnswerEarly() {
            if (timerInterval) {
                clearInterval(timerInterval);
                questionActive = false;
                revealAnswer(currentQuestion.correct);
            }
        }
        
        async function revealAnswer(correctAnswer) {
            console.log('Revealing answer:', correctAnswer);
            
            try {
                // Get current players and eliminate wrong ones
                const players = await supabase.select('players', `game_code=eq.${gameState.gameCode}&alive=eq.true`);
                console.log('Current players:', players);
                
                const eliminatedPlayers = [];
                const survivingPlayers = [];
                
                for (const player of players) {
                    // Players with position -1 (not positioned) are eliminated
                    if (player.position === -1 || player.position !== correctAnswer) {
                        await supabase.update('players', player.id, { 
                            alive: false,
                            last_activity: new Date().toISOString()
                        });
                        eliminatedPlayers.push(player);
                    } else {
                        survivingPlayers.push(player);
                    }
                }
                
                console.log('Eliminated:', eliminatedPlayers.length, 'Surviving:', survivingPlayers.length);
                
                // Play appropriate sound
                if (eliminatedPlayers.length > 0) {
                    playSound('fall');
                } else {
                    playSound('correct');
                }
                
                // Update host display immediately
                await updateHostDisplay();
                
                // Wait for animation, then check game state
                setTimeout(async () => {
                    await checkGameEnd(survivingPlayers.length);
                }, 3000);
                
            } catch (error) {
                console.error('Error in reveal answer:', error);
                // Reset button states on error
                show('startQuestionBtn');
                hide('revealBtn');
            }
        }
        
        async function checkGameEnd(playersAlive) {
            console.log('Checking game end, players alive:', playersAlive);
            
            if (playersAlive <= 1) {
                // Game over!
                await supabase.update('games', gameState.gameId, { 
                    status: 'finished',
                    last_activity: new Date().toISOString()
                });
                
                setTimeout(() => navigateTo('victory.html'), 2000);
                
            } else if (playersAlive === 2 && !gameState.suddenDeath) {
                // Activate sudden death!
                await activateSuddenDeath();
                resetHostControls();
                
            } else {
                // Continue game
                resetHostControls();
            }
        }
        
        function resetHostControls() {
            show('startQuestionBtn');
            hide('revealBtn');
            $('hostTimer').textContent = '-';
            $('hostTimerFill').style.width = '100%';
            $('hostTimerFill').classList.remove('danger');
        }
        
        async function activateSuddenDeath() {
            console.log('Activating sudden death!');
            
            gameState.setSuddenDeath(true);
            
            // Update database
            await supabase.update('games', gameState.gameId, { 
                sudden_death: true,
                last_activity: new Date().toISOString()
            });
            
            // Visual effects
            document.body.classList.add('sudden-death');
            $('stageLights').classList.add('sudden-death');
            show('hostSuddenDeathIndicator');
            
            playSound('suddenDeath');
            showSuddenDeathMessage();
        }
        
        function showSuddenDeathMessage() {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
                align-items: center; justify-content: center; z-index: 10000;
                animation: fadeIn 0.5s ease-out; text-align: center;
            `;
            message.innerHTML = `
                <div style="font-size: 8rem; animation: bounce 1s infinite;">ðŸ’€</div>
                <h1 style="font-size: 4rem; color: #ffb8b1; margin: 2rem 0;">SUDDEN DEATH!</h1>
                <p style="font-size: 1.5rem; color: white;">Only 2 players remain...</p>
                <p style="font-size: 1.25rem; color: white;">Hard questions only â€¢ 5 seconds each</p>
            `;
            
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 4000);
        }
        
        // FIXED initializePlayer function for game-stage.html
        async function initializePlayer() {
            console.log('=== INITIALIZING PLAYER VIEW ===');
            console.log('Player data - ID:', gameState.playerId, 'Name:', gameState.playerName, 'Emoji:', gameState.playerEmoji);
            
            // If we don't have player data, try to find it in the database
            if (!gameState.playerId || !gameState.playerName || !gameState.playerEmoji) {
                console.log('Missing player data, checking database...');
                
                try {
                    const players = await supabase.select('players', `game_code=eq.${gameState.gameCode}&alive=eq.true`);
                    console.log('Found players in database:', players);
                    
                    if (players && players.length > 0) {
                        // If there's only one player, assume it's us
                        if (players.length === 1) {
                            const player = players[0];
                            gameState.playerId = player.id;
                            gameState.playerName = player.name;
                            gameState.playerEmoji = player.emoji;
                            gameState.saveToStorage();
                            console.log('Player data recovered from database:', player);
                        } else {
                            // Multiple players - we need to guess or ask
                            console.warn('Multiple players found, using first one as fallback');
                            const player = players[0];
                            gameState.playerId = player.id;
                            gameState.playerName = player.name;
                            gameState.playerEmoji = player.emoji;
                            gameState.saveToStorage();
                        }
                    } else {
                        console.error('No player data found - this might actually be the host');
                        // If no players exist, this might actually be the host
                        showNotification('No player data found. Redirecting...', 'error');
                        setTimeout(() => navigateTo('index.html'), 2000);
                        return;
                    }
                } catch (error) {
                    console.error('Error fetching player data:', error);
                    showNotification('Unable to load player data.', 'error');
                    setTimeout(() => navigateTo('index.html'), 2000);
                    return;
                }
            }
            
            // Set player to "not positioned" initially - NO EMOJI ON BOARD
            gameState.setPosition(-1);
            
            // Update database to set position as -1 (not positioned)
            if (gameState.playerId) {
                try {
                    await supabase.update('players', gameState.playerId, { 
                        position: -1,
                        last_activity: new Date().toISOString()
                    });
                } catch (error) {
                    console.warn('Failed to update player position:', error);
                }
            }
            
            // Display player info (with fallbacks)
            $('myEmojiDisplay').textContent = gameState.playerEmoji || 'ðŸ˜€';
            $('myNameDisplay').textContent = gameState.playerName || 'Player';
            $('positionStatus').textContent = 'Click a trapdoor to position yourself!';
            
            // Make sure NO emoji appears on any trapdoor initially
            const existingEmoji = document.querySelector('.my-player-emoji');
            if (existingEmoji) {
                existingEmoji.remove();
            }
            
            // Update other player positions (but not our own since we're not positioned)
            await updatePlayerPositions();
            
            console.log('Player view initialized successfully');
        }
        
        function selectTrapdoor(position) {
            if (gameState.role !== 'player' || !questionActive) return;
            
            moveToTrapdoor(position);
        }
        
        async function moveToTrapdoor(position) {
            console.log('Moving to trapdoor:', position);
            playSound('movePlayer');
            
            // Remove player from current position
            const currentEmoji = document.querySelector('.my-player-emoji');
            if (currentEmoji) {
                currentEmoji.remove();
            }
            
            // Create or move player emoji
            const emoji = document.createElement('div');
            emoji.className = 'player-emoji my-player-emoji';
            emoji.textContent = gameState.playerEmoji;
            emoji.title = gameState.playerName;
            
            const container = $(`players${position}`);
            container.appendChild(emoji);
            
            gameState.setPosition(position);
            
            // Update status display
            const letters = ['A', 'B', 'C'];
            $('positionStatus').textContent = `Positioned on ${letters[position]}`;
            
            // Update database
            if (gameState.playerId) {
                await supabase.update('players', gameState.playerId, { 
                    position: position,
                    last_activity: new Date().toISOString()
                });
            }
        }
        
        function handleKeyInput(e) {
            if (gameState.role !== 'player' || !questionActive) return;
            
            let newPosition = -1;
            
            switch (e.key.toLowerCase()) {
                case '1':
                case 'a':
                    newPosition = 0;
                    break;
                case '2':
                case 'b':
                    newPosition = 1;
                    break;
                case '3':
                case 'c':
                    newPosition = 2;
                    break;
            }
            
            if (newPosition !== -1) {
                e.preventDefault();
                moveToTrapdoor(newPosition);
            }
        }
        
        // POLLING AND UPDATES
        function startGamePolling() {
            pollInterval = setInterval(async () => {
                try {
                    // Update player activity
                    if (gameState.playerId) {
                        await supabase.updatePlayerActivity(gameState.playerId);
                    }
                    
                    // Check game status
                    const game = await supabase.getGame(gameState.gameCode);
                    if (!game) {
                        cleanup();
                        navigateTo('index.html');
                        return;
                    }
                    
                    if (game.status === 'finished') {
                        cleanup();
                        navigateTo('victory.html');
                        return;
                    }
                    
                    // Update sudden death state
                    if (game.sudden_death && !gameState.suddenDeath) {
                        gameState.setSuddenDeath(true);
                        document.body.classList.add('sudden-death');
                        $('stageLights').classList.add('sudden-death');
                        
                        if (gameState.role === 'host') {
                            show('hostSuddenDeathIndicator');
                        } else {
                            show('playerSuddenDeathIndicator');
                        }
                        
                        showSuddenDeathMessage();
                    }
                    
                    // For players: check for new questions
                    if (gameState.role === 'player' && game.question_index !== null && game.question_index !== gameState.currentQuestionIndex) {
                        await handleNewPlayerQuestion(game);
                    }
                    
                    // Update displays
                    if (gameState.role === 'host') {
                        await updateHostDisplay();
                    } else {
                        await updatePlayerPositions();
                    }
                    
                } catch (error) {
                    console.warn('Polling error:', error);
                }
            }, 1000);
        }
        
        async function handleNewPlayerQuestion(game) {
            console.log('New question detected for player');
            
            gameState.currentQuestionIndex = game.question_index;
            gameState.currentQuestion = game.current_question;
            
            // Load questions if needed
            if (!gameState.questions || Object.keys(gameState.questions).length === 0) {
                gameState.questions = await supabase.getAllQuestionsGrouped();
            }
            
            const difficulty = game.sudden_death ? 'hard' : game.difficulty;
            const questionBank = gameState.questions[difficulty];
            
            if (questionBank && questionBank[game.question_index]) {
                const question = questionBank[game.question_index];
                displayPlayerQuestion(question, difficulty);
                questionActive = true;
                
                // Reset player position to "not positioned"
                gameState.setPosition(-1);
                $('positionStatus').textContent = 'Click a trapdoor to position yourself!';
                
                // Remove player emoji from board
                const currentEmoji = document.querySelector('.my-player-emoji');
                if (currentEmoji) {
                    currentEmoji.remove();
                }
            }
        }
        
        function displayPlayerQuestion(question, difficulty) {
            // Update difficulty badge
            const badge = $('playerDifficultyBadge');
            badge.textContent = difficulty.toUpperCase();
            badge.className = `difficulty-badge ${difficulty}`;
            
            // Update question text
            $('playerQuestionText').textContent = question.question;
            
            // Update answers
            question.answers.forEach((answer, index) => {
                $(`playerAnswer${index}`).textContent = answer;
            });
            
            // Update question number
            $('playerQuestionNumber').textContent = gameState.currentQuestion;
            
            // Show timer
            show('playerTimerContainer');
            
            // Start player timer
            startPlayerTimer();
        }
        
        function startPlayerTimer() {
            const duration = gameState.suddenDeath ? 5 : 
                           gameState.difficulty === 'easy' ? 5 :
                           gameState.difficulty === 'medium' ? 10 : 15;
            
            let timeLeft = duration;
            const timerEl = $('playerTimer');
            const timerFill = $('playerTimerFill');
            
            timerEl.classList.remove('danger');
            timerFill.style.width = '100%';
            timerFill.classList.remove('danger');
            
            const playerTimerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                const percentage = (timeLeft / duration) * 100;
                timerFill.style.width = percentage + '%';
                
                if (timeLeft <= 3) {
                    timerEl.classList.add('danger');
                    timerFill.classList.add('danger');
                    playSound('countdown');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(playerTimerInterval);
                    questionActive = false;
                }
            }, 1000);
        }
        
        async function updateHostDisplay() {
            try {
                const players = await supabase.select('players', `game_code=eq.${gameState.gameCode}&alive=eq.true`);
                
                $('hostPlayersAlive').textContent = players.length;
                
                // Clear position displays
                $('hostPlayersA').innerHTML = '';
                $('hostPlayersB').innerHTML = '';
                $('hostPlayersC').innerHTML = '';
                $('hostPlayersNone').innerHTML = '';
                
                // Group players by position
                players.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'host-player-item';
                    playerDiv.innerHTML = `<span>${player.emoji}</span> ${player.name}`;
                    
                    if (player.position === 0) {
                        $('hostPlayersA').appendChild(playerDiv);
                    } else if (player.position === 1) {
                        $('hostPlayersB').appendChild(playerDiv);
                    } else if (player.position === 2) {
                        $('hostPlayersC').appendChild(playerDiv);
                    } else {
                        $('hostPlayersNone').appendChild(playerDiv);
                    }
                });
                
            } catch (error) {
                console.warn('Error updating host display:', error);
            }
        }
        
        async function updatePlayerPositions() {
            try {
                const players = await supabase.select('players', `game_code=eq.${gameState.gameCode}&alive=eq.true`);
                
                // Clear all containers except our own emoji
                for (let i = 0; i < 3; i++) {
                    const container = $(`players${i}`);
                    const myEmoji = container.querySelector('.my-player-emoji');
                    container.innerHTML = '';
                    if (myEmoji) {
                        container.appendChild(myEmoji);
                    }
                }
                
                // Add other players (only if they're positioned)
                players.forEach(player => {
                    if (player.id !== gameState.playerId && player.position >= 0 && player.position <= 2) {
                        const emoji = document.createElement('div');
                        emoji.className = 'player-emoji other-player-emoji';
                        emoji.textContent = player.emoji;
                        emoji.title = player.name;
                        
                        const container = $(`players${player.position}`);
                        container.appendChild(emoji);
                    }
                });
                
                // Update player count
                $('playersAliveCount').textContent = players.length;
                
            } catch (error) {
                console.warn('Error updating player positions:', error);
            }
        }
        
        // HOST CONTROLS
        function setDifficulty(difficulty) {
            if (gameState.suddenDeath) return;
            
            gameState.setDifficulty(difficulty);
            playSound('buttonClick');
            
            document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.diff-btn.${difficulty}`).classList.add('active');
        }
        
        async function endGame() {
            if (confirm('Are you sure you want to end the game?')) {
                await supabase.update('games', gameState.gameId, { 
                    status: 'finished',
                    last_activity: new Date().toISOString()
                });
                navigateTo('victory.html');
            }
        }
        
        function cleanup() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }
    </script>
</body>
</html>
