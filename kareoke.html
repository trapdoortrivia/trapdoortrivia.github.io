<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karaoke Recording Thing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background for a "karaoke" feel */
            color: #e2e8f0;
        }
        .container {
            max-width: 900px;
        }
        .file-input-label {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
            background-color: #4a5568;
        }
        video {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .rounded-xl { border-radius: 0.75rem; }
        .text-area {
            resize: none;
            overflow-y: scroll;
            height: 150px;
        }
    </style>
</head>
<body class="p-6">

    <div class="container mx-auto p-4 bg-gray-800 rounded-xl shadow-xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-teal-300">Karaoke Recorder</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="flex flex-col">
                <div class="video-container mb-6">
                    <video id="video-player" class="w-full rounded-lg" controls></video>
                </div>
                
                <div>
                    <label for="video-upload" class="file-input-label flex items-center justify-center p-4 border-2 border-dashed border-gray-600 rounded-lg text-lg text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                        </svg>
                        <span id="file-name-display">Click here or drag & drop a video file</span>
                        <input type="file" id="video-upload" class="hidden" accept="video/*">
                    </label>
                </div>
            </div>

            <div class="flex flex-col">
                <h2 class="text-2xl font-semibold mb-4 text-center text-indigo-300">Connect Your Phone</h2>
                
                <div class="bg-gray-700 p-4 rounded-lg mb-4 text-center">
                    <p class="font-medium">Connection Status:</p>
                    <p id="connection-status" class="text-gray-400 text-sm">Not connected</p>
                </div>

                <div class="bg-gray-700 p-4 rounded-lg mb-4">
                    <p class="font-bold mb-2">1. On your computer:</p>
                    <button id="create-offer-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-colors mb-2">
                        Start Mic & Generate Offer
                    </button>
                    <textarea id="offer-sdp" class="w-full text-area bg-gray-900 text-gray-200 p-2 rounded-lg text-xs" readonly placeholder="Your offer will appear here. Copy it and paste it into the same page on your phone."></textarea>
                </div>

                <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="font-bold mb-2">2. On your phone:</p>
                    <textarea id="answer-sdp" class="w-full text-area bg-gray-900 text-gray-200 p-2 rounded-lg text-xs mb-2" placeholder="Paste the offer from your computer here."></textarea>
                    <button id="accept-offer-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md transition-colors mb-2">
                        Accept Offer & Start Mic
                    </button>
                </div>

                <div class="bg-gray-700 p-4 rounded-lg mt-4">
                    <p class="font-bold mb-2">3. Back on your computer:</p>
                    <textarea id="final-answer-sdp" class="w-full text-area bg-gray-900 text-gray-200 p-2 rounded-lg text-xs" placeholder="Paste the answer from your phone here to complete the connection."></textarea>
                    <button id="accept-final-answer-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-md transition-colors mt-2">
                        Connect
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Get the necessary DOM elements for video
        const videoInput = document.getElementById('video-upload');
        const videoPlayer = document.getElementById('video-player');
        const fileNameDisplay = document.getElementById('file-name-display');
        const fileInputLabel = document.querySelector('.file-input-label');
        
        // Event listener for the video file input change
        videoInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileNameDisplay.textContent = `File selected: ${file.name}`;
                const fileURL = URL.createObjectURL(file);
                videoPlayer.src = fileURL;
                videoPlayer.load();
                videoPlayer.addEventListener('loadeddata', () => {
                    URL.revokeObjectURL(fileURL);
                }, { once: true });
            }
        });

        // Add drag and drop functionality
        fileInputLabel.addEventListener('dragover', (event) => {
            event.preventDefault();
            fileInputLabel.classList.add('border-teal-300');
        });
        fileInputLabel.addEventListener('dragleave', () => {
            fileInputLabel.classList.remove('border-teal-300');
        });
        fileInputLabel.addEventListener('drop', (event) => {
            event.preventDefault();
            fileInputLabel.classList.remove('border-teal-300');
            const file = event.dataTransfer.files[0];
            if (file) {
                videoInput.files = event.dataTransfer.files;
                const changeEvent = new Event('change');
                videoInput.dispatchEvent(changeEvent);
            }
        });

        // WebRTC setup and logic
        const createOfferBtn = document.getElementById('create-offer-btn');
        const acceptOfferBtn = document.getElementById('accept-offer-btn');
        const acceptFinalAnswerBtn = document.getElementById('accept-final-answer-btn');
        const offerSdpTextarea = document.getElementById('offer-sdp');
        const answerSdpTextarea = document.getElementById('answer-sdp');
        const finalAnswerSdpTextarea = document.getElementById('final-answer-sdp');
        const connectionStatus = document.getElementById('connection-status');
        
        const iceServers = {
            'iceServers': [{
                'urls': 'stun:stun.l.google.com:19302'
            }]
        };

        let localPeerConnection;
        let remotePeerConnection;

        createOfferBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                localPeerConnection = new RTCPeerConnection(iceServers);
                stream.getTracks().forEach(track => {
                    localPeerConnection.addTrack(track, stream);
                });

                localPeerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        offerSdpTextarea.value += JSON.stringify(event.candidate);
                    } else {
                        connectionStatus.textContent = 'Offer created. Copy this text and paste it into the same page on your phone.';
                    }
                };

                const offer = await localPeerConnection.createOffer();
                await localPeerConnection.setLocalDescription(offer);
                offerSdpTextarea.value = JSON.stringify(localPeerConnection.localDescription);
                connectionStatus.textContent = 'Generating offer...';

            } catch (error) {
                console.error('Error getting microphone or creating offer:', error);
                connectionStatus.textContent = 'Error: could not access mic.';
            }
        });

        acceptOfferBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                remotePeerConnection = new RTCPeerConnection(iceServers);
                stream.getTracks().forEach(track => {
                    remotePeerConnection.addTrack(track, stream);
                });

                remotePeerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        finalAnswerSdpTextarea.value += JSON.stringify(event.candidate);
                    } else {
                        connectionStatus.textContent = 'Answer created. Copy this text and paste it back into your computer.';
                    }
                };

                const offer = JSON.parse(answerSdpTextarea.value);
                await remotePeerConnection.setRemoteDescription(new RTCSessionDescription(offer));

                const answer = await remotePeerConnection.createAnswer();
                await remotePeerConnection.setLocalDescription(answer);
                finalAnswerSdpTextarea.value = JSON.stringify(remotePeerConnection.localDescription);
                connectionStatus.textContent = 'Generating answer...';

            } catch (error) {
                console.error('Error accepting offer or creating answer:', error);
                connectionStatus.textContent = 'Error: could not process offer or access mic.';
            }
        });

        acceptFinalAnswerBtn.addEventListener('click', async () => {
            try {
                const answer = JSON.parse(finalAnswerSdpTextarea.value);
                await localPeerConnection.setRemoteDescription(new RTCSessionDescription(answer));

                localPeerConnection.ontrack = (event) => {
                    if (event.track.kind === 'audio') {
                        console.log('Received audio track from phone.');
                        const remoteAudio = document.createElement('audio');
                        remoteAudio.srcObject = event.streams[0];
                        remoteAudio.autoplay = true;
                        document.body.appendChild(remoteAudio);
                        connectionStatus.textContent = 'Connection successful! Audio stream received.';
                    }
                };

            } catch (error) {
                console.error('Error accepting final answer:', error);
                connectionStatus.textContent = 'Error: could not connect with the provided answer.';
            }
        });
    </script>
</body>
</html>
